<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Icon from page -->
    <link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="view/images/favicon.ico" type="image/x-icon">

    <!-- Adding libs and styles -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="../css/user_main_page.css" />
    <title>CataEmprego</title>
  </head>

  <!-- First page app  -->
  <body>   
    <script type="module">
      import supabaseAuthentication from "../../control/SupabaseUtils.js"
      import searchJobs from "../../control/searchSupabase.js"

      const supabaseUrl = process.env.SUPABASE_KEY;
      const supabaseKey = process.env.SUPABASE_URL;
      const _supabase = supabaseAuthentication(supabaseUrl, supabaseKey);

      let jobsFiltered = [];
      let allJobs = [];
      let messageToPrint = "Você não pesquisou por nenhuma vaga :(";
      let i;
      const searchInput = document.querySelector("[data-search]");
      const userCardContainer = document.querySelector("[data-jobs-cards-container]");
      const userCardTemplate = document.querySelector("[data-user-template]");
      const userTextBeforeSearch = document.querySelector("h1");
      userTextBeforeSearch.innerHTML = messageToPrint;

      function removeAllChildNodes(node) {
          i = (typeof(node) == "object") ? node : document.querySelector(node);

          while (i.hasChildNodes()) {
            i.removeChild(i.firstChild);
          }
      }

      searchInput.addEventListener("keydown", e => {
        removeAllChildNodes("[data-jobs-cards-container]")
        removeAllChildNodes("h1")
        if (e.code == "Enter"){
          const value = e.target.value.toLowerCase()
          jobsFiltered = searchJobs(value,_supabase)
          jobsFiltered.then(arrayPosition => {
            arrayPosition.forEach(position => {
              const card = userCardTemplate.content.cloneNode(true).children[0]
              const position_company = card.querySelector("[position-company]")
              const position_name = card.querySelector("[position-name]")
              const detail_button_id = card.querySelector("[detail-button-id]")
              position_company.textContent = position.companyName
              position_name.textContent = position.positionName
              detail_button_id.innerText = position.positionId
              userCardContainer.append(card)
              return { id:position.positionId, name: position.positionName, company: position.companyName, element: card }
            }) 
          })
        }
      })    

      document.body.addEventListener("click", jobDetailment, false)

      function jobDetailment(e) {
        e=e || window.event;
        var target = e.target || e.srcElement;
        if(target.className.match("button")) {
          let position_id = e.target.children[0].textContent || e.target.children[0].innerText; 
          window.location.href = "../pages/job_detailment.html?position_id=" + position_id; 
        }
      }
    </script>

    <main>
      <img class="video_page_logo" src="../images/logo.png"></div>  
      <div class="search_wrapper">
        <input id="search_jobs" class="search_bar" type="search" placeholder="Que emprego você quer?" aria-label="Busca de empregos." data-search>
      </div>   
    </main>
    <h1></h1>
    <div class="jobs-cards" data-jobs-cards-container></div>
      <template data-user-template>
      <div class="job_card">
         <div style="background:white; display: flex; margin-bottom: 5px;">
           <div class="job_card_ret1">Empresa</div><div class="job_card_ret2" position-company></div>  
         </div>
         <div style="background:white; display: flex; margin-bottom: 5px;">
          <div class="job_card_ret1">Posição</div><div class="job_card_ret2" position-name></div>
         </div>
       <button class="detail_button">Detalhes <div style = "display:none" detail-button-id></div></button>
      </div>
      </template>  
    
    <script type="module" src="../../control/searchSupabase.js"></script>
    <script type="module" src="../../control/SupabaseUtils.js"></script>
  </body>
</html>