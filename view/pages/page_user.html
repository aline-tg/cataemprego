<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Icon from page -->
    <link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="view/images/favicon.ico" type="image/x-icon">

    <!-- Adding libs and styles -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="../css/user_main_page.css" />
    <title>CataEmprego</title>
  </head>

  <!-- First page app  -->
  <body>   
    <script type="module">
      import supabaseAuthentication from "../../control/SupabaseUtils.js"
      import searchJobs from "../../control/searchSupabase.js"

      const supabaseUrl = 'https://heyuuynqxqobgiotfgaj.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhleXV1eW5xeHFvYmdpb3RmZ2FqIiwicm9sZSI6ImFub24iLCJpYXQiOjE2NTcyNDcyMTUsImV4cCI6MTk3MjgyMzIxNX0.Y7Q_scMNfYmZXmeJWbZI4OUj7ic7GKCDao_j5TP4-Ts';
      const _supabase = supabaseAuthentication(supabaseUrl, supabaseKey);

      let jobsFiltered = [];
      let allJobs = [];
      let messageToPrint = "Você ainda não buscou nenhuma vaga :(";
      let i;
      const searchInput = document.querySelector("[data-search]");
      const userCardContainer = document.querySelector("[data-jobs-cards-container]");
      const userCardTemplate = document.querySelector("[data-user-template]");

      function removeAllChildNodes(node) {
          i = (typeof(node) == "object") ? node : document.querySelector(node);

          while (i.hasChildNodes()) {
            i.removeChild(i.firstChild);
          }
      }

      searchInput.addEventListener("keydown", e => {
        removeAllChildNodes("[data-jobs-cards-container]")
        if (e.code == "Enter"){
          const value = e.target.value.toLowerCase()
          jobsFiltered = searchJobs(value,_supabase)
          console.log(allJobs)
          jobsFiltered.then(arrayPosition => {
            arrayPosition.forEach(position => {
              const card = userCardTemplate.content.cloneNode(true).children[0]
              const position_company = card.querySelector("[position-company]")
              const position_name = card.querySelector("[position-name]")
              position_company.textContent = position.companyName
              position_name.textContent = position.positionName
              const job_id = position.positionId
              userCardContainer.append(card)
              return { name: position.positionName, company: position.companyName, element: card }
            }) 
          })
        }
      })      

    </script>

    <main>
      <img class="video_page_logo" src="../images/logo.png"></div>  
      <div class="search_wrapper">
        <input id="search_jobs" class="search_bar" type="search" placeholder="Que emprego você quer?" aria-label="Busca de empregos." data-search>
      </div>   
    </main>
    <div class="jobs-cards" data-jobs-cards-container></div>
      <template data-user-template>
      <div class="job_card">
         <div style="background:white; display: flex; margin-bottom: 5px;">
           <div class="job_card_ret1">Empresa</div><div class="job_card_ret2" position-company></div>  
         </div>
         <div style="background:white; display: flex; margin-bottom: 5px;">
          <div class="job_card_ret1">Posição</div><div class="job_card_ret2" position-name></div>
         </div>
       <!-- <button class="detail_button" onclick="location.href='job_detailment.html?job_id='{job_id}">Detalhes</button> -->
      </div>
      </template>  
    

    <script type="module" src="../../control/searchSupabase.js"></script>
    <script type="module" src="../../control/SupabaseUtils.js"></script>
  </body>
</html>