<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Icon from page -->
    <link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="view/images/favicon.ico" type="image/x-icon">

    <!-- Adding libs and styles -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script type="module" src="../../control/SupabaseUtils.js"></script>
    <script type="module" src="../../model/objects/Position.js"></script> 
    <link rel="stylesheet" href="../css/job_detailment.css" />
    <title>Detalhamento de Vagas</title>
  </head>

  <!-- First page app  -->
  <body>
    <script type = "module">
      import supabaseAuthentication from "../../control/SupabaseUtils.js"
      import Company from "../../model/objects/Company.js"
      import Address from "../../model/objects/Address.js"

      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
      }

      function getQueryVariable(variable)
          {
         var query = window.location.search.substring(1);
         var vars = query.split("&");
         for (var i=0;i<vars.length;i++) {
                 var pair = vars[i].split("=");
                 if(pair[0] == variable){return pair[1];}
         }
         return(false);
        }

      if (document.cookie.split(';').some((item) => item.trim().startsWith('session_id=')) && getCookie("session_id").length > 1) {
        const _supabase = supabaseAuthentication();

        let company_id = getQueryVariable("company_id");
        const compCardTemplate = document.querySelector("[company-detailment-template]");
        const {data: company, error: error_reading} = await _supabase
                                                          .from("registered-companies")
                                                          .select(`*,
                                                                  companies-address (company_id,
                                                                                     street,
                                                                                     city,
                                                                                     state,
                                                                                     district)`)
                                                          .eq("company_id", company_id)

        var company_filtered = company[0]

        var address = new Address(company_id, company_filtered.street, company_filtered.city, company_filtered.state, company_filtered.district)

        var company = new Position(company_filtered.position_id,
                                   company_filtered.company_id,
                                   company_filtered.company_name,
                                   company_filtered.position_name,
                                   company_filtered.position_location,
                                   company_filtered.position_duty_hours,
                                   company_filtered.position_salary,
                                   company_filtered.position_benefits,
                                   company_filtered.position_description)  

        const card_job = compCardTemplate.content.cloneNode(true).children[0]
        const company_name = card_job.querySelector("[company-name]")
        const company_cnpj = card_job.querySelector("[company-cnpj]")
        const company_street = card_job.querySelector("[company-street]")
        const company_neighborhood = card_job.querySelector("[company-neighborhood]")
        const company_city = card_job.querySelector("[company-city]")
        const company_state = card_job.querySelector("[company-state]")
        const company_phone = card_job.querySelector("[company-phone]")
        company_name.textContent = position.companyName
        company_cnpj.textContent = position.positionName
        company_street.textContent = position.positionLocation
        company_neighborhood.textContent = position.positionDutyHours
        company_city.textContent = position.positionSalary
        company_state.textContent = position.positionDescription
        company_phone.textContent = position.positionDescription
        document.body.append(card_job)

        async function logout() {
          let old_cookie_value = getCookie("session_id") 
          let user_id = getCookie("user_id")
          window.document.cookie = "session_id=;Path=/"
          window.document.cookie = "user_id=;Path=/"

          let update_info = {
            session_id: ""
          }

          const {data: data_update, error: error_update } = await _supabase
                                    .from('users-auth')
                                    .update(update_info)
                                    .eq("user_id",user_id)
        }

        const userLogout = document.getElementById("logout")
        userLogout.addEventListener("click", e => {
          logout()
          document.location.href = "../pages/logout.html"
        })

    } else {
        document.location.href = "../pages/needs_login.html"
      }
      
    </script>

    <main>
      <img class="video_page_logo" src="../images/logo.png">
      <button id="logout" class="button--logout">Deslogar</button>
    </main>
    <template company-detailment-template>
    <div class="detailment" data-company-detailment style="margin:auto;">
      <h5>Razão Social:</h5>
      <div class="user--input" company-name></div>
      <h5>CNPJ:</h5>
      <div class="user--input" company-cnpj></div>
      <h5>Endereço</h5>
      <h5>Rua:</h5>
      <div class="user--input" company-street></div>
      <h5>Bairro:</h5>
      <div class="user--input" company-neighborhood></div>
      <h5>Cidade:</h5>
      <div class="user--input" company-city></div>
      <h5>Estado:</h5>
      <div class="user--input" company-state></div>
      <h5>Telefone:</h5>
      <div class="user--input" company-phone></div>
      <button class="resume_button">Cadastrar Currículo</button>
      <button class="back_button" onclick="location.href='../pages/page_user.html';">Voltar</button>
    </div>
    </template>
  </body>
</html>